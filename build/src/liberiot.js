'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var config=require('../config');var Q=require('q');var mqtt=require('mqtt');var Liberiot=function(){function Liberiot(){var _this=this;_classCallCheck(this,Liberiot);this.config=config;this.liberiotClient=mqtt.connect('mqtt://'+this.config.liberiot.server+':'+this.config.liberiot.port);this.liberiotClient.on('connect',function(){return _this.init()})}_createClass(Liberiot,[{key:'init',value:function init(){var _this2=this;console.log('Liberiot MQTT client is up and running');this.getMac().then(function(a){_this2.config.gateway_key=a;_this2.publishGatewayCoords();_this2.publishStatus('CONNECTED');_this2.publishStatus();_this2.setPeriodicHeartBeat(60);_this2.liberiotClient.subscribe(_this2.getControlTopic()+'/#');console.log(_this2.getControlTopic())}).catch(function(a){return console.error(a)})}},{key:'publish',value:function publish(a){this.liberiotClient.publish(this.getNetworkTopic()+'/'+a.slice(6,30),a)}},{key:'getMac',value:function getMac(){var a=Q.defer();require('getmac').getMac(function(b,c){if(b){a.reject(b)}var d=new RegExp(':','g');var e=c.replace(d,'').toUpperCase();a.resolve(e)});return a.promise}},{key:'getNetworkTopic',value:function getNetworkTopic(){return this.config.liberiot.main_topic+'/'+this.config.liberiot.user_key+'/'+this.config.gateway_key+'/network'}},{key:'getControlTopic',value:function getControlTopic(){return this.config.liberiot.main_topic+'/'+this.config.liberiot.user_key+'/'+this.config.gateway_key+'/control'}},{key:'getGatewayTopic',value:function getGatewayTopic(){return this.config.liberiot.main_topic+'/'+this.config.liberiot.user_key+'/'+this.config.gateway_key+'/gateway'}},{key:'setPeriodicHeartBeat',value:function setPeriodicHeartBeat(a){var _this3=this;setInterval(function(){return _this3.publishStatus()},a*1000)}},{key:'publishStatus',value:function publishStatus(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'RUNNING';this.liberiotClient.publish(this.getGatewayTopic(),a);if(a==='RUNNING'){console.log(this.getDate()+' Heartbeat...')}}},{key:'publishGatewayCoords',value:function publishGatewayCoords(){var a=this.config.coordinates.latitude+', '+this.config.coordinates.longitude;this.liberiotClient.publish(this.getGatewayTopic()+'/coord',a)}},{key:'getDate',value:function getDate(){var a=new Date;var b=a.getHours().toString();var c=a.getMinutes().toString();var d=a.getSeconds().toString();b.length<2?b='0'+b:null;c.length<2?c='0'+c:null;d.length<2?d='0'+d:null;return'['+b+':'+c+':'+d+']'}},{key:'getLiberiotMqtt',value:function getLiberiotMqtt(){return this.liberiotClient}}]);return Liberiot}();exports.default=Liberiot;