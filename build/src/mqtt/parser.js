'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.default=parse;exports.getCrc=getCrc;exports.checkCrc=checkCrc;var _schemes=require('../schemes');var _schemes2=_interopRequireDefault(_schemes);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var lodash=require('lodash');var cnSensorTransmissions={};var DECIMALS=2;function parse(a){var b=a.toString();var c=getData(b);var d=getCrc(b);if(checkCrc(c,d)){return parseContents(a)}else{console.log('An error was found in the package: '+b+'. CRC: '+d);return null}}function getData(a){var b=a.slice(6,a.length-2);return b}function getCrc(a){var b=a.slice(a.length-2,a.length);return b}function checkCrc(a,b){var c=0;for(var d=0;d<a.length;d+=2){var e=a[d]+a[d+1];c+=parseInt(e,16)}return c.toString(16).toUpperCase().slice(1,3)===b}function parseContents(a){var b=getData(a);var c=getContents(b);var d=parseTransmission(a);if(checkNonce(d.uid.full,d.cn)){return emitTransmission(d,c)}else{console.log('Nonce error');return null}}function getContents(a){var b=a.slice(30,a.length);return b}function parseTransmission(a){var b={uid:{}};b.rr=parseInt(a.slice(1,3),16);b.ll=parseInt(a.slice(3,5),16);b.uid.full=a.slice(6,30);b.uid.id=a.slice(6,22);b.uid.code=a.slice(22,30);b.cn=parseInt(a.slice(30,32),16);b.fnc=parseInt(a.slice(32,34),16);b.reg=parseInt(a.slice(34,36),16);b.measures=[];return b}function checkNonce(a,b){var c=false;if(cnSensorTransmissions[a]){if(cnSensorTransmissions[a]!==b){cnSensorTransmissions[a]=b;c=true}}else{cnSensorTransmissions[a]=b;c=true}return c}function emitTransmission(a,b){var c=_schemes2.default['scheme'+a.uid.code];if(!c){console.log('No scheme found for '+a.uid.full);return null}var d=findRegister(c,a.reg);if(d){d.endpoints.forEach(function(e){var f={contents:b,endpoint:e,register:d,transmission:a};if(e.type==='bool'){// is boolean
var g=parseBooleanMeasure(f);var h={register:f.register,endpoint:f.endpoint,unit:null,value:g};var j=parseBoolean(a,h);if(!j.error){j.type='bool'}}else{// not boolean
parseMeasureUnits(f)}})}return a}function findRegister(a,b){return a.registers.filter(function(c){return c.id==b})[0]}function parseBooleanMeasure(a){var b;if(a.endpoint.size%1!=0){// 8 booleans in 1 byte
var c=a.endpoint.pos.toString().split('.');var d=a.contents.slice(c[0]*2,c[0]*2+2);var e=fillWithZeros(parseInt(d,16).toString(2));b=e.slice(parseInt(c[1]),parseInt(c[1])+1)}else{// 1 boolean in 1 byte
b=a.contents.slice(a.endpoint.pos*2,a.endpoint.pos*2+a.endpoint.size*2);b==='01'?b=1:b=0}return b}function parseBoolean(a,b){var c={};c.value=Number(b.value);c.endpoint=b.endpoint.name;c.type='bool';if(!isNaN(c.value)){c.error=false;a.measures.push(c)}else{c={error:true};console.log('NaN value encountered in transmission '+a._id)}return c}function parseMeasureUnits(a){var b=getFloatValue(a.contents,a.endpoint).toFixed(DECIMALS);var c={endpoint:a.endpoint,register:a.register,value:b};parseUnits(a.transmission,c)}function getFloatValue(a,b){return parseInt(a.slice(b.pos*2,b.pos*2+b.size*2),16)}function parseUnits(a,b){var c={register:b.register,endpoint:b.endpoint,value:b.value};if(b.endpoint.units.length>0){b.endpoint.units.forEach(function(d){c.unit=d;parseMeasure(a,c)})}else{c.unit={name:'non-measurable',factor:1,offset:0};parseMeasure(a,c)}}function parseMeasure(a,b){var c={};c.value=Number((b.value*b.unit.factor+b.unit.offset).toFixed(DECIMALS));c.endpoint=b.endpoint.name;c.type=b.unit.name;if(!isNaN(c.value)){a.measures.push(c);c.error=false}else{c={error:true};console.log('NaN value encountered in transmission '+a._id)}return c}